name: Check versions

on:
  workflow_run:
    workflows: [CI]
    types: [completed]

jobs:
  first:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: [
          {name: 'easyhard-api', folder: 'api'},
          {name: 'easyhard', folder: 'core'},
          {name: 'easyhard-loader', folder: 'loader'},
          {name: 'easyhard-router', folder: 'router'},
          {name: 'easyhard-forms', folder: 'forms'},
          {name: 'easyhard-styles', folder: 'styles'},
          {name: 'easyhard-common', folder: 'common'},
          {name: 'easyhard-bridge', folder: 'bridge'},
          {name: 'easyhard-client', folder: 'client'},
          {name: 'easyhard-server', folder: 'server'},
          {name: 'easyhard-server-uws', folder: 'server-uws'},
        ]
    steps:
      - uses: actions/checkout@v2
      - name: Check if version has been updated
        if: ${{github.event.workflow_run.conclusion == 'success'}}
        id: checkVersion
        uses: EndBug/version-check@v1.6.0
        with:
          diff-search: true
          file-name: packages/${{matrix.package.folder}}/package.json
      - name: Dispatch publish
        if: steps.checkVersion.outputs.changed == 'true'
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Publish
          token: ${{secrets.PERSONAL_TOKEN}}
          inputs: '{
            "name": "${{matrix.package.name}}",
            "folder": "${{matrix.package.folder}}",
            "version": "${{steps.checkVersion.outputs.version}}"
            "buildWorkflowId": "${{github.event.workflow_run.id}}"
            }'

